(window.webpackJsonp=window.webpackJsonp||[]).push([[77],{817:function(t,a,s){"use strict";s.r(a);var n=s(40),e=Object(n.a)({},(function(){var t=this,a=t.$createElement,s=t._self._c||a;return s("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[s("h2",{attrs:{id:"说在前面"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#说在前面"}},[t._v("#")]),t._v(" 说在前面")]),t._v(" "),s("p",[t._v("这篇博文全是干货,内容很长,但是值得收藏！！！")]),t._v(" "),s("h3",{attrs:{id:"问题背景"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#问题背景"}},[t._v("#")]),t._v(" 问题背景")]),t._v(" "),s("p",[t._v("\b我最近在做一个自己的音乐Web App,期间遇到不少瓶颈,这次记录一下我困扰了将近一周的问题.我在一个组件内点击了播放按键,将这个点击事件派发到父组件,然后传入ID到player组件内,进行异步请求,获取到该首音乐的播放地址,然后通过vue.$ref去调用audio.play()方法,经过调试发现,在谷歌浏览器、火狐浏览器等都能正常播放,但是唯独苹果旗下的safari播放器不能播放.请看代码:\n"),t._v("\ndom部分：\n"),s("code",[t._v('html <audio :src="songurl" ref="audio" @canplay="ready" @error="error" @timeupdate="updateTime"></audio>')])]),t._v(" "),s("p",[t._v('这里的":src=songurl",我是在data里面初始化了一个’songurl’ :')]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",[s("code",[t._v("```js\ndata() {\n            return {\n                songurl: '',\n                songReady: false,\n                currentTime: 0\n            }\n        },     \n```\n")])])]),s("p",[t._v("watch部分：")]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",[s("code",[t._v("```js\nwatch: {\n            currentSong() {\n                var v = this;\n                v.getSongUrl(v.currentSong.id).then(() => {\n                        v.$refs.audio.play();\n                })\n            },\n            playing(newPlaying) {\n                var v = this;\n                const audio = v.$refs.audio;\n                v.getSongUrl(v.currentSong.id).then(() => {\n                    newPlaying ? audio.play() : audio.pause();\n                })\n\n            }\n        },\n```\n")])])]),s("p",[t._v("可以看到,我是先去调用了v.getSongUrl( ) 这个方法去获取歌曲URL,这个promise执行完成之后,然后再去播放歌曲.\n以下为getSongUrl( ) 方法：\n```js\ngetSongUrl(id) {\nvar v = this;\nreturn v.$axios.get('api/song/url', {\nparams: {\nid: id\n}\n}).then(response => {\nif (response.data.code === 200) {\nv.songurl = response.data.data[0].url;\n//console.log(\"地址：\" + v.songurl);\n}\n}).catch(error => {\nconsole.log(error);\n});")]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",[s("code",[t._v("            },\n```\n")])])]),s("p",[t._v("所以就是,我先去异步请求,然后将获取的url赋值给data里面的songurl,然后绑定到audio的src上面,然后再去调用audio.play. 但是safari就是不能播放.")]),t._v(" "),s("h3",{attrs:{id:"问题探究"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#问题探究"}},[t._v("#")]),t._v(" 问题探究")]),t._v(" "),s("p",[t._v("遇到问题,先进行思考,为什么谷歌浏览器等一众浏览器都能正常播放,唯独safari不能？是不是safari有什么特别之处？于是我去搜索了一番,一查还真是,请看：")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://i.loli.net/2018/11/18/5bf103da21030.png",alt:"QQ20181118-141626@2x.png"}})]),t._v(" "),s("p",[t._v("safari对播放做了限制,除非用户自己进行了交互操作,但是去调用"),s("code",[t._v("audio.play()")]),t._v(",而我在这里,是先进行了异步请求,才去执行了这个"),s("code",[t._v("audio.play()")]),t._v(",所以不能播放.说起来safari还真是尿性,为了防止用户损失流量,就做了这个限制,那有什么办法解决呢？请看：")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://i.loli.net/2018/11/18/5bf105f1cae71.png",alt:"QQ20181118-142537@2x.png"}})]),t._v(" "),s("p",[t._v("意思是说,官方还是没有解除这个限制.这里还说到,Apple 在 iOS 4.2.1 中修复了异步请求之后播放的功能,所以这种变通方法在 iOS 4.2.1 和后续版本中是不起作用的.终于找到问题所在,原来就是不能这样实现.所以我就必须重构自己的业务逻辑,不能在播放之前进行异步请求,于是我将获取歌曲URL的操作放置到另一个组件内,然后利用props传递到player组件里面来,简单来说我将异步请求放到前面去实现了.然而这样就能播放了吗？答案是还是不能!!!我懵逼了,我不是将异步请求放置到前面去实现了吗,为什么还是不能实现？于是我去搜索了一下,原来有一个"),s("code",[t._v("Vue.$nextTick")]),t._v("方法.那么这个方法的作用是什么？请看：\n"),s("img",{attrs:{src:"https://i.loli.net/2018/11/18/5bf10ec8e657b.png",alt:"QQ20181118-150210@2x.png"}}),t._v("\n意思是说,我可能数据还没加载好,就去更新dom了,所以应该将更新dom的操作放置到"),s("code",[t._v("Vue.$nextTick")]),t._v("方法中,这样就可以保证将更新dom的操作放置到异步请求之后去实现了:")]),t._v(" "),s("div",{staticClass:"language-js extra-class"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[t._v(" watch"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n            "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("currentSong")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n                "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("var")]),t._v(" v "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n                v"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("$nextTick")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n                    v"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("$refs"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("audio"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("play")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n                "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n            "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n            "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("playing")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("newPlaying")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n                "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("var")]),t._v(" v "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n                "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" audio "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" v"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("$refs"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("audio"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n                v"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("$nextTick")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n                    newPlaying "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("?")]),t._v(" audio"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("play")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" audio"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("pause")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n                "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n            "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n")])])]),s("p",[t._v("然而这样做之后就能播放了吗？答案是还是不能！！为什么呢？")]),t._v(" "),s("h3",{attrs:{id:"继续探究"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#继续探究"}},[t._v("#")]),t._v(" 继续探究")]),t._v(" "),s("p",[t._v("那为什么加了"),s("code",[t._v("Vue.$nextTick")]),t._v("方法还是无法实现播放?我们应该去研究研究Vue的这个方法,但是在这之前,我们先来看看JS的运行机制:\n来自阮一峰的"),s("a",{attrs:{href:"http://www.ruanyifeng.com/blog/2014/10/event-loop.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("一篇文章"),s("OutboundLink")],1),t._v(",大致分为以下几个步骤:")]),t._v(" "),s("ol",[s("li",[t._v("所有同步任务都在主线程上执行,形成一个执行栈（execution context stack）.")]),t._v(" "),s("li",[t._v('主线程之外,还存在一个"任务队列"（task queue）.只要异步任务有了运行结果,就在"任务队列"之中放置一个事件.')]),t._v(" "),s("li",[t._v('一旦"执行栈"中的所有同步任务执行完毕,系统就会读取"任务队列",看看里面有哪些事件.那些对应的异步任务,于是结束等待状态,进入执行栈,开始执行.')]),t._v(" "),s("li",[t._v("主线程不断重复上面的第三步.")])]),t._v(" "),s("p",[t._v("主线程的执行过程就是一个 "),s("code",[t._v("tick")]),t._v(",而所有的异步结果都是通过 “任务队列” 来调度被调度. 消息队列中存放的是一个个的任务（task）. 规范中规定 task 分为两大类,分别是 "),s("code",[t._v("macro task")]),t._v(" 和 "),s("code",[t._v("micro task")]),t._v(".在浏览器环境中,常见的 "),s("code",[t._v("macro task")]),t._v(" 有 "),s("code",[t._v("setTimeout")]),t._v("、"),s("code",[t._v("MessageChannel")]),t._v("、"),s("code",[t._v("postMessage")]),t._v("、"),s("code",[t._v("setImmediate")]),t._v("；常见的 "),s("code",[t._v("micro task")]),t._v(" 有 "),s("code",[t._v("MutationObsever")]),t._v(" 和 "),s("code",[t._v("Promise.then")]),t._v(".")]),t._v(" "),s("p",[t._v("回到Vue的"),s("code",[t._v("nextTick")]),t._v(",先生介绍一下这个方法的使用场景:\nvue将异步调用的方法其实是push到一个队列里面,然后内部调用一次nextTick,统一去更新dom,所以数据到DOM数据的变化要下一个tick才能完成.\n在2.5以上的版本中,它调度的优先顺序为:\n"),s("code",[t._v("setImmediate")]),t._v(" -> "),s("code",[t._v("MessageChannel")]),t._v(" -> "),s("code",[t._v("setTimeout")])]),t._v(" "),s("h3",{attrs:{id:"对-audio-播放的影响"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#对-audio-播放的影响"}},[t._v("#")]),t._v(" 对 audio 播放的影响")]),t._v(" "),s("p",[t._v("知道了调度顺序之后,那到底nextTick是如何影响adio的？经过我的测试,是"),s("code",[t._v("MessageChannel")]),t._v("影响了audio的播放.就是因为在2.5版本以上,"),s("code",[t._v("nextTick")]),t._v("优先使用"),s("code",[t._v("MessageChannel")]),t._v(",造成了audio不能播放.")]),t._v(" "),s("h3",{attrs:{id:"解决方法"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#解决方法"}},[t._v("#")]),t._v(" 解决方法")]),t._v(" "),s("p",[t._v("知道了什么原因,我们就可以解决问题了,那我们在这里跳过"),s("code",[t._v("MessageChannel")]),t._v(",不就行了吗.我直接将全局的"),s("code",[t._v("MessageChannel")]),t._v("禁用掉:")]),t._v(" "),s("div",{staticClass:"language-js extra-class"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("noop")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\nwindow"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("MessageChannel "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" noop\nwindow"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("setImmediate "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" noop\n")])])]),s("p",[t._v("这样就跳过了MessageChannel,我再运行项目跑了一下,完美解决!!")])])}),[],!1,null,null,null);a.default=e.exports}}]);